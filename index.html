<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>13th CAFS FC Election Site</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'custom-main': '#c39f09',
            'custom-main-dark': '#a08107',
            'custom-sub': '#1e5629',
            'custom-text': '#1F2933',
            'custom-light-gold': '#fcf8eb'
          },
          keyframes: {
            fadeIn: { '0%': { opacity: '0', transform: 'scale(.98)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
            fadeOut: { '0%': { opacity: '1', transform: 'scale(1)' }, '100%': { opacity: '0', transform: 'scale(.98)' } }
          },
          animation: {
            fadeIn: 'fadeIn 0.6s ease-out forwards',
            fadeOut: 'fadeOut 0.6s ease-out forwards'
          }
        }
      }
    }
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background: #f8fafc; margin:0; }
    /* Center everything vertically when voting content is active */
    .center-viewport { min-height: calc(100vh - 4rem); display:flex; align-items:center; justify-content:center; }
    /* Prevent turnout overflow on small screens */
    .turnout-item { white-space: normal; word-break: break-word; }
    .progress-bar-bg { background: #e6edf0; border-radius: 9999px; height: 10px; overflow: hidden; }
    .progress-bar-fill { height: 100%; transition: width 0.7s ease; background: linear-gradient(90deg,#c39f09,#a08107); }
    /* Larger logos */
    .logo-header { height: 64px; } /* header logo */
    .logo-cafs { width: 220px; height: 220px; } /* sign in */
    .logo-13th { width: 160px; height: 160px; } /* voting area */
    @media (max-width:640px) {
      .logo-cafs { width:160px; height:160px; }
      .logo-header { height:48px; }
      .logo-13th { width:120px; height:120px; }
    }
    /* Accessibility / small tweaks */
    .vote-item { cursor: default; transition: all 0.2s ease-in-out; border: 1px solid #E5E7EB; position: relative; background-color: white; padding: 0.5rem 0; border-radius: 0.5rem; display: grid; grid-template-columns: 3fr 1fr 1fr; align-items: stretch; min-height: 4.5rem; }
    .vote-column, .abstain-column { cursor:pointer; padding:0.5rem 0.25rem; display:flex; flex-direction:column; align-items:center; justify-content:center; outline:none; }
    .selection-indicator { height:1.4rem; width:1.4rem; border-radius:9999px; border:3px solid #ccc; background:transparent; transition:all .15s; }
    .vote-column.selected .selection-indicator { background:#c39f09; border-color:#c39f09; }
    .abstain-column.selected .selection-indicator { background:#64748B; border-color:#475569; }
    .selection-text { font-size:0.875rem; font-weight:600; }
    .candidate-name-container { min-width:0; padding-left:1rem; padding-right:0.5rem; display:flex; align-items:center; }
    .candidate-name-link { text-decoration:underline; cursor:pointer; color:#1e5629; font-weight:600; }
    .highlight-error { border-color:#ef4444 !important; box-shadow:0 0 0 2px rgba(239,68,68,0.35); border-width:2px !important; }
    .btn-primary-submit { background-color:#1e5629; color:white; font-weight:700; }
    .btn-primary-submit:hover { background-color:#0d3413; }

    /* responsive small-screen adjustments */
    @media(max-width:639px) {
      .vote-item { grid-template-columns: 2fr 1fr 1fr; min-height:4rem; padding:0.25rem 0; }
      .selection-text { font-size:0.65rem; font-weight:700; line-height:1; }
      .selection-indicator { height:1.1rem; width:1.1rem; border-width:2px; }
    }

    /* helper classes for show/hide with fade */
    .animate-fadeIn { animation: fadeIn 0.6s ease-out forwards; }
    .animate-fadeOut { animation: fadeOut 0.6s ease-out forwards; }
  </style>
</head>
<body class="flex flex-col items-center">

  <!-- Central message -->
  <div id="central-message-container" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 hidden">
    <div id="message-display" class="px-4 py-3 rounded-lg text-sm sm:text-base text-center font-medium shadow-lg"></div>
  </div>

  <!-- CAFS themed warning (session only) -->
  <div id="warning-popup" class="fixed inset-0 hidden z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="relative bg-white rounded-xl shadow-2xl w-11/12 max-w-md">
      <div class="bg-custom-sub text-white px-4 py-3 rounded-t-xl font-bold text-center">‚ö†Ô∏è Notice</div>
      <div class="p-5 text-custom-text text-center font-medium">Hello this is a warning.</div>
      <div class="p-4 text-center">
        <button id="close-warning-btn" class="px-4 py-2 rounded-lg font-bold bg-custom-main text-custom-sub hover:bg-custom-main-dark transition">OK</button>
      </div>
    </div>
  </div>

  <!-- Header (keeps visible after login) -->
  <header id="header" class="hidden w-full max-w-5xl mt-6 bg-white rounded-xl shadow-md px-5 py-3 flex items-center justify-between border-t-8 border-custom-sub">
    <img src="Header.png" alt="Header Logo" class="logo-header object-contain" />
    <div class="flex items-center space-x-3">
      <div class="text-right hidden sm:block">
        <div id="user-name" class="font-semibold text-custom-text"></div>
        <div id="user-email" class="text-xs text-gray-500"></div>
      </div>
      <img id="user-photo" class="w-10 h-10 rounded-full border border-gray-300" alt="User photo" onerror="this.src='https://placehold.co/32x32/f1f1f1/1F2933?text=U'">
      <button id="logout-btn" class="px-3 py-2 rounded-md bg-custom-main text-custom-sub font-semibold hover:bg-custom-main-dark transition">Logout</button>
    </div>
  </header>

  <!-- MAIN AREA (Login + Turnout as top block) -->
  <main id="top-block" class="w-full max-w-5xl mt-8 px-4">
    <div id="prelogin-row" class="flex flex-col sm:flex-row items-start sm:items-stretch gap-6">

      <!-- SIGN-IN CARD -->
      <article id="login-card" class="bg-white w-full sm:w-1/2 rounded-xl shadow-2xl p-6 border-t-8 border-custom-sub flex flex-col items-center justify-center">
        <img id="cafs-logo-signin" src="cafsfc.png" alt="CAFS FC Logo" class="logo-cafs object-contain mb-4" />
        <h1 class="text-2xl sm:text-3xl font-extrabold text-custom-sub text-center">13th CAFS FC Election</h1>
        <p id="auth-warning-message" class="mt-3 hidden text-red-600 text-sm font-semibold bg-red-50 p-2 rounded-md"></p>

        <button id="google-login-btn" class="mt-6 px-6 py-3 w-full sm:w-auto btn-primary-submit rounded-lg shadow-lg font-semibold flex items-center justify-center">
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5 mr-3 bg-white p-0.5 rounded" alt="google"> Sign-in with UP MAIL
        </button>

        <p class="mt-4 text-xs sm:text-sm text-red-700 font-semibold bg-red-50 p-3 rounded-lg border border-red-200 text-center">
          Authentication Required: You must sign in with your <strong>UP Mail (@up.edu.ph)</strong> account.
        </p>

        <p id="error-message" class="mt-4 text-red-500 text-sm hidden">Sign-in failed. Please try again.</p>
      </article>

      <!-- TURNOUT DASHBOARD -->
      <aside id="turnout-dashboard" class="bg-gray-100 w-full sm:w-1/2 rounded-xl shadow-lg p-5 flex flex-col gap-4">
        <h2 class="text-lg sm:text-xl font-bold text-custom-sub text-center">üó≥Ô∏è VOTER TURNOUT</h2>

        <div class="turnout-item">
          <div class="flex justify-between items-baseline mb-1">
            <span class="text-sm font-medium text-gray-700">Total Turnout</span>
            <span id="total-turnout-text" class="text-base font-extrabold text-custom-sub">--%</span>
          </div>
          <div class="progress-bar-bg w-full">
            <div id="total-turnout-bar" class="progress-bar-fill" style="width:0%"></div>
          </div>
        </div>

        <div class="turnout-item">
          <div class="flex justify-between items-baseline mb-1">
            <span class="text-sm font-medium text-gray-700">BS Agriculture</span>
            <span id="agri-percent" class="text-sm font-semibold text-custom-sub">--%</span>
          </div>
          <div class="progress-bar-bg w-full">
            <div id="agri-bar" class="progress-bar-fill" style="width:0%"></div>
          </div>
        </div>

        <div class="turnout-item">
          <div class="flex justify-between items-baseline mb-1">
            <span class="text-sm font-medium text-gray-700">BS Agricultural Biotechnology</span>
            <span id="biotech-percent" class="text-sm font-semibold text-custom-sub">--%</span>
          </div>
          <div class="progress-bar-bg w-full">
            <div id="biotech-bar" class="progress-bar-fill" style="width:0%"></div>
          </div>
        </div>

        <div class="turnout-item">
          <div class="flex justify-between items-baseline mb-1">
            <span class="text-sm font-medium text-gray-700">BS Food Science & Tech</span>
            <span id="food-percent" class="text-sm font-semibold text-custom-sub">--%</span>
          </div>
          <div class="progress-bar-bg w-full">
            <div id="food-bar" class="progress-bar-fill" style="width:0%"></div>
          </div>
        </div>

      </aside>
    </div>
  </main>

  <!-- VOTING AREA (centered, hidden until after login) -->
  <section id="voting-wrapper" class="hidden w-full max-w-4xl mt-8 px-4">
    <div class="center-viewport">
      <div id="voting-canvas" class="w-full bg-white rounded-xl shadow-2xl p-6 md:p-10 border-t-8 border-custom-main animate-fadeIn">
        <div class="flex flex-col items-center gap-4">
          <img src="13th.png" class="logo-13th object-contain" alt="13th logo"/>
          <div id="user-traceability" class="mx-auto p-3 text-center bg-custom-light-gold rounded-lg border border-custom-main/30 w-full">
            <span class="font-bold text-custom-sub text-sm sm:text-base">VOTER ID:</span>
            <code id="user-id-display" class="font-mono text-custom-text text-sm sm:text-base font-semibold ml-2">...</code>
          </div>

          <!-- Voter Info -->
          <div id="voter-info-section" class="w-full max-w-xl">
            <h2 class="text-lg font-bold text-custom-sub mb-4">Voter Information</h2>
            <div class="space-y-3">
              <input id="student-number" type="text" placeholder="Student Number e.g., 2021-12345" class="w-full border rounded-lg p-3" />
              <select id="degree-program" class="w-full border rounded-lg p-3">
                <option value="">Select your course</option>
                <option value="BS Agriculture">Bachelor of Science in Agriculture</option>
                <option value="BS Agricultural Biotechnology">Bachelor of Science in Agricultural Biotechnology</option>
                <option value="BS Food Science and Technology">Bachelor of Science in Food Science and Technology</option>
              </select>
              <button id="proceed-to-ballot" class="w-full py-3 bg-custom-main text-custom-sub font-bold rounded-lg hover:bg-custom-main-dark transition">Proceed to Ballot</button>
            </div>
          </div>

          <!-- Ballot (kept collapsed until proceed) -->
          <form id="voting-form" class="w-full mt-6 opacity-50 pointer-events-none">
            <div id="ballot-container" class="space-y-4">
              <p class="text-center text-gray-500">Loading candidate data...</p>
            </div>
            <button id="submit-vote-btn" type="submit" class="mt-6 w-full py-3 btn-primary-submit rounded-lg">Review and Submit Vote</button>
          </form>
        </div>
      </div>
    </div>
  </section>
  <!-- Candidate Modal (no platform details) -->
  <div id="candidate-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="relative bg-white rounded-xl shadow-2xl w-11/12 max-w-lg p-6">
      <button id="close-modal" class="absolute top-3 right-3 text-gray-500 hover:text-black font-bold">‚úï</button>
      <div class="flex flex-col items-center gap-3">
        <img id="modal-photo" class="w-32 h-32 rounded-full border-4 border-custom-main object-cover" alt="Candidate Photo">
        <h3 id="modal-name" class="text-xl font-bold text-custom-sub"></h3>
        <p id="modal-position" class="text-sm text-gray-600"></p>
      </div>
    </div>
  </div>

  <!-- Review / Confirmation Modal -->
  <div id="review-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="relative bg-white rounded-xl shadow-2xl w-11/12 max-w-2xl p-6 overflow-y-auto max-h-[80vh]">
      <h2 class="text-xl font-bold text-custom-sub mb-3 text-center">Review Your Vote</h2>
      <div id="review-content" class="space-y-3 text-sm"></div>
      <div class="mt-5 flex justify-center gap-3">
        <button id="cancel-review" class="px-5 py-2 rounded-lg bg-gray-300 text-gray-800 font-semibold hover:bg-gray-400">Cancel</button>
        <button id="confirm-submit" class="px-5 py-2 rounded-lg bg-custom-main text-custom-sub font-bold hover:bg-custom-main-dark">Confirm Submit</button>
      </div>
    </div>
  </div>

  <!-- JS Section -->
  <script type="module">
    /* ========= Session Warning ========= */
    const warningPopup = document.getElementById('warning-popup');
    const closeWarningBtn = document.getElementById('close-warning-btn');
    if (!sessionStorage.getItem('warningShown')) {
      warningPopup.classList.remove('hidden');
    }
    closeWarningBtn.addEventListener('click', () => {
      warningPopup.classList.add('hidden');
      sessionStorage.setItem('warningShown', 'true');
    });

    /* ========= Responsive Turnout Fetch ========= */
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTnZExJ9injJGTsk1uFOUT45te0_gXPu0BGvAhgpWwNRIKxwgV3bXW-gygrr4omsBY9luXXxpPe1lE6/pub?output=csv";
    async function loadTurnout() {
      try {
        const res = await fetch(csvUrl);
        const text = await res.text();
        const rows = text.split(/\\r?\\n/).map(r => r.split(','));
        // G and H columns => index 6 and 7 (0-based)
        const exp = {
          total: parseFloat(rows[5][6]),
          food: parseFloat(rows[4][6]),
          biotech: parseFloat(rows[3][6]),
          agri: parseFloat(rows[2][6])
        };
        const act = {
          total: parseFloat(rows[5][7]),
          food: parseFloat(rows[4][7]),
          biotech: parseFloat(rows[3][7]),
          agri: parseFloat(rows[2][7])
        };
        const pct = (a,b)=> b?Math.min(100,Math.round((a/b)*100)) : 0;
        const totalPct=pct(act.total,exp.total);
        const agriPct=pct(act.agri,exp.agri);
        const bioPct=pct(act.biotech,exp.biotech);
        const foodPct=pct(act.food,exp.food);
        document.getElementById('total-turnout-text').textContent = totalPct + '%';
        document.getElementById('agri-percent').textContent = agriPct + '%';
        document.getElementById('biotech-percent').textContent = bioPct + '%';
        document.getElementById('food-percent').textContent = foodPct + '%';
        document.getElementById('total-turnout-bar').style.width = totalPct + '%';
        document.getElementById('agri-bar').style.width = agriPct + '%';
        document.getElementById('biotech-bar').style.width = bioPct + '%';
        document.getElementById('food-bar').style.width = foodPct + '%';
      } catch(e){ console.error('Turnout load error', e); }
    }
    loadTurnout();

    /* ========= Login Transition ========= */
    const loginCard=document.getElementById('login-card');
    const topBlock=document.getElementById('top-block');
    const votingWrapper=document.getElementById('voting-wrapper');
    const header=document.getElementById('header');
    const googleLoginBtn=document.getElementById('google-login-btn');

    googleLoginBtn.addEventListener('click',()=>{
      // Simulate Firebase login success; integrate your real auth below
      loginCard.classList.add('animate-fadeOut');
      setTimeout(()=>{
        topBlock.classList.add('hidden');
        header.classList.remove('hidden');
        votingWrapper.classList.remove('hidden');
        votingWrapper.classList.add('animate-fadeIn');
      },600);
    });

    /* ========= Candidate Modal Logic ========= */
    const modal=document.getElementById('candidate-modal');
    const closeModalBtn=document.getElementById('close-modal');
    closeModalBtn.addEventListener('click',()=>modal.classList.add('hidden'));
    function openCandidateModal(name,position,photo){
      document.getElementById('modal-name').textContent=name;
      document.getElementById('modal-position').textContent=position;
      document.getElementById('modal-photo').src=photo;
      modal.classList.remove('hidden');
    }

    /* ========= Voter Info to Ballot Transition ========= */
    const proceedBtn=document.getElementById('proceed-to-ballot');
    const voterInfo=document.getElementById('voter-info-section');
    const ballotForm=document.getElementById('voting-form');
    proceedBtn.addEventListener('click',()=>{
      const sn=document.getElementById('student-number').value.trim();
      const course=document.getElementById('degree-program').value;
      if(!sn||!course){
        voterInfo.classList.add('animate-pulse');
        setTimeout(()=>voterInfo.classList.remove('animate-pulse'),1000);
        return;
      }
      voterInfo.classList.add('hidden');
      ballotForm.classList.remove('opacity-50','pointer-events-none');
      ballotForm.classList.add('animate-fadeIn');
    });
    /* ========= Firebase Integration ========= */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, addDoc, doc, setDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDORLpt-SkOwhEK0VRCxOifUkgNYlhR8mo",
      authDomain: "cafs-fc-election.firebaseapp.com",
      projectId: "cafs-fc-election",
      storageBucket: "cafs-fc-election.appspot.com",
      messagingSenderId: "44234562463",
      appId: "1:44234562463:web:1d532bdb65a40750160cfa",
      measurementId: "G-FFSHZ6CCKP"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const db = getFirestore(app);

    // login (override simulation)
    googleLoginBtn.addEventListener('click', async () => {
      try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;
        if (!user.email.endsWith('@up.edu.ph')) {
          document.getElementById('auth-warning-message').classList.remove('hidden');
          document.getElementById('auth-warning-message').textContent = 'Please use your UP Mail (@up.edu.ph).';
          await signOut(auth);
          return;
        }
        document.getElementById('user-name').textContent = user.displayName || '';
        document.getElementById('user-email').textContent = user.email;
        document.getElementById('user-photo').src = user.photoURL || 'https://placehold.co/32x32';
        loginCard.classList.add('animate-fadeOut');
        setTimeout(() => {
          topBlock.classList.add('hidden');
          header.classList.remove('hidden');
          votingWrapper.classList.remove('hidden');
          votingWrapper.classList.add('animate-fadeIn');
        }, 600);
      } catch (err) {
        console.error(err);
        document.getElementById('error-message').classList.remove('hidden');
      }
    });

    // Logout
    document.getElementById('logout-btn').addEventListener('click', async () => {
      await signOut(auth);
      location.reload();
    });

    /* ========= Candidate Data ========= */
    async function loadCandidates() {
      const ballotContainer = document.getElementById('ballot-container');
      ballotContainer.innerHTML = '<p class="text-center text-gray-500">Loading candidate data...</p>';
      try {
        const snapshot = await getDocs(collection(db, "candidates"));
        if (snapshot.empty) {
          ballotContainer.innerHTML = '<p class="text-center text-gray-500">No candidates found.</p>';
          return;
        }
        ballotContainer.innerHTML = '';
        const positions = {};
        snapshot.forEach(docu => {
          const c = docu.data();
          if (!positions[c.position]) positions[c.position] = [];
          positions[c.position].push(c);
        });

        Object.keys(positions).forEach(position => {
          const group = positions[position];
          const posDiv = document.createElement('div');
          posDiv.innerHTML = `<h3 class="text-xl font-bold text-custom-sub mb-2">${position}</h3>`;
          group.forEach(candidate => {
            const row = document.createElement('div');
            row.className = 'vote-item';
            row.innerHTML = `
              <div class="candidate-name-container">
                <span class="candidate-name-link" onclick="openCandidateModal('${candidate.name}','${candidate.position}','${candidate.photo}')">${candidate.name}</span>
              </div>
              <div class="vote-column" data-position="${position}" data-name="${candidate.name}">
                <div class="selection-indicator"></div>
                <span class="selection-text">Vote</span>
              </div>
              <div class="abstain-column" data-position="${position}">
                <div class="selection-indicator"></div>
                <span class="selection-text">Abstain</span>
              </div>
            `;
            posDiv.appendChild(row);
          });
          ballotContainer.appendChild(posDiv);
        });

        ballotContainer.addEventListener('click', e => {
          const target = e.target.closest('.vote-column, .abstain-column');
          if (!target) return;
          const row = target.closest('.vote-item');
          row.querySelectorAll('.vote-column, .abstain-column').forEach(el => el.classList.remove('selected'));
          target.classList.add('selected');
        });
      } catch (err) {
        ballotContainer.innerHTML = '<p class="text-center text-red-500">Error loading candidates.</p>';
        console.error(err);
      }
    }
    loadCandidates();

    /* ========= Review and Submit ========= */
    const reviewModal = document.getElementById('review-modal');
    const reviewContent = document.getElementById('review-content');
    const cancelReview = document.getElementById('cancel-review');
    const confirmSubmit = document.getElementById('confirm-submit');
    const voteForm = document.getElementById('voting-form');

    voteForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const votes = {};
      document.querySelectorAll('.vote-item').forEach(item => {
        const position = item.closest('div').querySelector('h3').textContent;
        const selectedVote = item.querySelector('.vote-column.selected');
        const abstainVote = item.querySelector('.abstain-column.selected');
        votes[position] = selectedVote ? selectedVote.dataset.name : (abstainVote ? 'Abstain' : '');
      });

      let html = '';
      Object.entries(votes).forEach(([pos, choice]) => {
        html += `<div><strong>${pos}:</strong> ${choice || '<span class=\"text-gray-400\">No selection</span>'}</div>`;
      });
      reviewContent.innerHTML = html;
      reviewModal.classList.remove('hidden');
    });

    cancelReview.addEventListener('click',()=>reviewModal.classList.add('hidden'));

    confirmSubmit.addEventListener('click', async ()=>{
      reviewModal.classList.add('hidden');
      const votes={};
      document.querySelectorAll('.vote-item').forEach(item=>{
        const position=item.closest('div').querySelector('h3').textContent;
        const selectedVote=item.querySelector('.vote-column.selected');
        const abstainVote=item.querySelector('.abstain-column.selected');
        votes[position]=selectedVote?selectedVote.dataset.name:(abstainVote?'Abstain':'');
      });
      try{
        const user = auth.currentUser;
        const sn=document.getElementById('student-number').value.trim();
        const course=document.getElementById('degree-program').value;
        await addDoc(collection(db,'votes'),{
          uid:user.uid,
          email:user.email,
          name:user.displayName,
          studentNumber:sn,
          course:course,
          votes:votes,
          timestamp:Timestamp.now()
        });
        alert('‚úÖ Your vote has been successfully recorded.');
        location.reload();
      }catch(e){
        console.error('Vote submission error',e);
        alert('‚ùå There was an error submitting your vote. Please try again.');
      }
    });
  </script>
</body>
</html>
