<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>13th CAFS FC Election ‚Äî Official</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'custom-main': '#c39f09',
            'custom-main-dark': '#a08107',
            'custom-sub': '#1e5629',
            'custom-text': '#1F2933',
            'custom-light-gold': '#fcf8eb'
          },
          keyframes: {
            fadeIn: { '0%': { opacity: '0', transform: 'scale(.99)' }, '100%': { opacity: '1', transform: 'scale(1)' } }
          },
          animation: { fadeIn: 'fadeIn 0.45s ease-out forwards' }
        }
      }
    }
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --bg: #f8fafc; }
    html,body{height:100%}
    body{font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial; margin:0; background:var(--bg); color:#1F2933;-webkit-font-smoothing:antialiased}
    .card-shadow{box-shadow:0 8px 20px rgba(12,18,22,0.06),0 4px 8px rgba(12,18,22,0.04)}
    .container-max{max-width:1180px;margin:0 auto;padding:0 16px;box-sizing:border-box}

    /* Ballot and controls */
    .vote-item{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:.6rem;border-radius:12px;background:white;border:1px solid #E5E7EB}
    .candidate-name-container{flex:1;padding:0 .5rem}
    .candidate-name-link{font-weight:700;color:#1e5629;cursor:pointer;display:block}
    .vote-controls{display:flex;align-items:center;gap:10px}
    .control-pill{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:.55rem .8rem;border-radius:10px;cursor:pointer;border:1px solid #e6e9ee;min-width:130px;user-select:none}
    .control-pill .label{font-weight:700}
    .control-pill .dot{width:18px;height:18px;border-radius:50%;border:2px solid #cbd5e1;background:transparent}
    .control-pill.selected .dot{background:#c39f09;border-color:#c39f09}
    .control-pill.abstain.selected .dot{background:#64748B;border-color:#475569}
    .control-pill:active{transform:translateY(1px)}
    .control-pill[aria-disabled="true"]{opacity:.6;pointer-events:none}

    /* Mobile layout: NAME on top, then Vote O | Abstain O */
    @media (max-width:640px){
      .vote-item{flex-direction:column;align-items:flex-start;gap:8px}
      .vote-controls{width:100%;gap:10px;justify-content:space-between}
      .control-pill{min-width:44%;flex:1;padding:.6rem .8rem}
      /* visual separator with a vertical line in between pills (mobile portrait) */
      .controls-sep{width:2px;height:36px;background:#eef2f4;border-radius:2px;margin:0 6px}
    }
    @media (max-width:420px){
      .vote-controls{flex-direction:column;gap:8px}
      .control-pill{width:100%;justify-content:space-between}
    }

    /* turnout */
    .turnout-card{border-radius:12px;padding:14px;background:white;border:1px solid rgba(30,86,41,0.06)}
    .progress-bg{background:#eef2f4;border-radius:9999px;height:12px;overflow:hidden}
    .progress-fill{height:100%;transition:width .8s ease;background:linear-gradient(90deg,#c39f09,#a08107)}

    /* nominee modal course display */
    .candidate-course{font-size:.95rem;color:#475569;margin-top:6px;font-weight:600}

    /* modals/backdrops */
    .modal-backdrop{background:rgba(0,0,0,0.6);backdrop-filter:blur(4px)}
    /* site disabled when voting ended: block interactions; modal overrides pointer-events */
    .voting-ended-disable *{pointer-events:none!important;user-select:none!important;opacity:0.6!important}
    #voting-ended-modal{pointer-events:auto!important;opacity:1!important;z-index:99999!important;position:fixed;inset:0;display:flex;align-items:center;justify-content:center}

    /* small helpers */
    .hidden-el{display:none}
  </style>
</head>
<body>

  <!-- Voting Concluded Modal will be inserted by JS when now > H8 (no close button) -->

  <!-- Header -->
  <header id="header" class="hidden bg-white rounded-b-lg card-shadow border-b-4 border-custom-sub">
    <div class="container-max flex items-center justify-between p-3">
      <div class="flex items-center gap-3">
        <img src="Header.png" alt="Header" style="height:56px">
        <div class="hidden sm:block">
          <h1 class="text-lg font-extrabold text-custom-sub">13th CAFS FC Election</h1>
          <div class="text-xs text-gray-500">Official Voting Portal</div>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <div class="hidden sm:block text-right">
          <div id="user-name" class="font-semibold text-custom-text"></div>
          <div id="user-email" class="text-xs text-gray-500"></div>
        </div>
        <img id="user-photo" class="w-10 h-10 rounded-full border border-gray-300" alt="User photo" onerror="this.src='https://placehold.co/32x32/f1f1f1/1F2933?text=U'">
        <button id="logout-btn" class="px-3 py-2 rounded-md bg-custom-main text-custom-sub font-semibold hover:bg-custom-main-dark">Logout</button>
      </div>
    </div>
  </header>

  <!-- Main / Login & Turnout -->
  <main class="min-h-[72vh] flex items-center justify-center py-8">
    <div class="container-max flex flex-col md:flex-row items-start gap-6">

      <!-- Login card -->
      <div class="bg-white rounded-xl card-shadow p-6 md:p-8 border-t-8 border-custom-sub w-full max-w-md">
        <img src="cafsfc.png" class="w-48 mx-auto mb-4" alt="CAFS logo">
        <h2 class="text-2xl font-extrabold text-custom-sub text-center mb-2">13th CAFS FC Election</h2>
        <p class="text-sm text-gray-700 text-center mb-4">Sign in with your UP Mail to access the official ballot.</p>
        <button id="google-login-btn" class="w-full py-3 rounded-lg bg-custom-sub text-white font-bold flex items-center justify-center gap-3">
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5" alt="google"> Sign in with UP Mail
        </button>
        <p class="mt-4 text-xs text-red-700 font-semibold bg-red-50 p-2 rounded text-center">Use your <strong>@up.edu.ph</strong> account only</p>
      </div>

      <!-- Turnout -->
      <aside class="turnout-card w-full md:w-96">
        <h3 class="text-lg font-bold text-custom-sub mb-1">üó≥Ô∏è Voter Turnout</h3>
        <div class="text-xs text-gray-500 mb-4">Updated live</div>
        <div class="mb-3">
          <div class="flex justify-between text-sm mb-2"><span>Total Turnout</span><span id="total-turnout-text">--%</span></div>
          <div class="progress-bg"><div id="total-turnout-bar" class="progress-fill" style="width:0%"></div></div>
        </div>
        <div class="mt-3 space-y-3 text-sm">
          <div><div class="flex justify-between"><span>BS Agriculture</span><span id="agri-percent">--%</span></div><div class="progress-bg"><div id="agri-bar" class="progress-fill" style="width:0%"></div></div></div>
          <div><div class="flex justify-between"><span>BS Agricultural Biotechnology</span><span id="biotech-percent">--%</span></div><div class="progress-bg"><div id="biotech-bar" class="progress-fill" style="width:0%"></div></div></div>
          <div><div class="flex justify-between"><span>BS Food Science and Technology</span><span id="food-percent">--%</span></div><div class="progress-bg"><div id="food-bar" class="progress-fill" style="width:0%"></div></div></div>
        </div>
      </aside>

    </div>
  </main>

  <!-- Voting wrapper (hidden until authenticated & voter info provided) -->
  <section id="voting-wrapper" class="hidden w-full max-w-4xl mx-auto px-4 mb-16">
    <div class="bg-white rounded-xl card-shadow p-8 border-t-8 border-custom-main mt-8">
      <div class="flex flex-col items-center gap-4">
        <img src="13th.png" alt="13th logo" class="w-48 mb-2">

        <div id="user-trace" class="w-full max-w-xl mx-auto p-3 text-center bg-custom-light-gold rounded-lg border border-custom-main/30">
          <span class="font-bold text-custom-sub text-sm sm:text-base">VOTER ID:</span>
          <code id="user-id-display" class="font-mono text-custom-text text-sm sm:text-base font-semibold ml-2">...</code>
        </div>

        <div id="voter-info-section" class="w-full max-w-xl">
          <h3 class="text-lg font-bold text-custom-sub mb-3">Voter Information</h3>
          <p class="text-sm text-gray-600 mb-3">Enter your student number and program to access the ballot.</p>

          <label class="block mb-3">
            <span class="font-medium">Student Number</span>
            <input id="student-number" type="text" placeholder="e.g., 2021-12345" class="mt-1 w-full border border-gray-300 rounded-lg p-3">
            <p id="student-number-error" class="hidden text-xs text-red-600 mt-1">Format must be <code>20xx-xxxxx</code>.</p>
          </label>

          <label class="block mb-4">
            <span class="font-medium">Degree Program</span>
            <select id="degree-program" class="mt-1 w-full border border-gray-300 rounded-lg p-3">
              <option value="">Select your course</option>
              <option value="BS Agriculture">BS Agriculture</option>
              <option value="BS Agricultural Biotechnology">BS Agricultural Biotechnology</option>
              <option value="BS Food Science and Technology">BS Food Science and Technology</option>
            </select>
          </label>

          <button id="proceed-to-ballot" class="w-full py-3 bg-custom-sub text-white font-bold rounded-lg">Proceed to Ballot</button>
        </div>

        <!-- Ballot -->
        <form id="voting-form" class="w-full mt-6 opacity-50 pointer-events-none">
          <div class="bg-yellow-50 border-l-4 border-custom-main p-4 rounded-md mb-4 text-sm text-gray-700">
            <strong>INSTRUCTIONS:</strong> Please select either ‚ÄúVote‚Äù or ‚ÄúAbstain‚Äù for each candidate. Click a candidate‚Äôs name to view their basic information. For fuller details, please consult the official <a href="https://www.facebook.com/uplbcafsfc" target="_blank" rel="noreferrer" class="text-custom-sub font-semibold underline hover:text-custom-main-dark">CAFS Freshman Council Facebook Page</a>.
          </div>

          <div id="ballot-container" class="space-y-4">
            <p class="text-center text-gray-500">Loading official candidate data...</p>
          </div>

          <button id="submit-vote-btn" type="submit" class="mt-6 w-full py-3 bg-custom-sub text-white font-bold rounded-lg">Review and Submit Vote</button>
        </form>
      </div>
    </div>
  </section>

  <!-- Nominee modal (shows Name + Course only; photo clickable to open viewer) -->
  <div id="nominee-popup" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="absolute inset-0 modal-backdrop"></div>
    <div class="relative w-full max-w-lg bg-white rounded-xl overflow-hidden">
      <div class="p-6 pt-12 bg-custom-light-gold max-h-[80vh] overflow-y-auto">
        <div class="flex items-start gap-4">
          <img id="nominee-photo" class="w-24 h-24 sm:w-36 sm:h-36 object-cover rounded-md border-4 border-custom-main cursor-pointer" src="https://placehold.co/128x128/f1f1f1/1F2933?text=ID" alt="Nominee Photo">
          <div>
            <p class="text-xs font-semibold text-gray-500 uppercase -mb-1">NOMINATED POSITION</p>
            <h3 id="nominee-position" class="font-extrabold mb-1 leading-tight"></h3>
            <div id="nominee-name" class="font-bold text-custom-text"></div>
            <div id="nominee-course" class="candidate-course"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Fullscreen Photo Viewer -->
  <div id="photo-viewer" class="hidden fixed inset-0 bg-black/80 z-[999] flex items-center justify-center p-4">
    <div class="absolute inset-0"></div>
    <button id="close-photo-viewer" class="absolute top-4 right-6 text-white text-3xl font-bold hover:text-gray-300">&times;</button>
    <img id="photo-viewer-img" src="" alt="Candidate Photo" class="relative max-h-[90vh] max-w-[90vw] rounded-lg shadow-2xl border-4 border-custom-main">
  </div>

  <!-- Verifier popup -->
  <div id="verifier-popup" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-gray-800/70"></div>
    <div class="relative bg-white rounded-xl w-full max-w-md border-t-8 border-custom-sub shadow-2xl overflow-y-auto max-h-[90vh]">
      <div class="p-6 pb-0">
        <h2 class="text-xl font-bold text-custom-sub mb-2 text-center">Final Vote Verification</h2>
        <p class="text-xs text-gray-600 mb-4 text-center">Please review your selections before final submission.</p>
      </div>
      <div id="vote-summary-table-container" class="px-6 overflow-y-auto flex-grow min-h-0 mb-4"></div>
      <div class="flex gap-3 p-6 pt-0">
        <button id="change-vote-btn" class="flex-1 py-2 border rounded-lg">Edit Ballot</button>
        <button id="confirm-vote-btn" class="flex-1 py-2 bg-custom-main text-custom-sub rounded-lg font-bold">Confirm & Submit</button>
      </div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>

  <!-- Firebase SDKs + main script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ===== Firebase config (your real project) =====
    const firebaseConfig = {
      apiKey: "AIzaSyBdj6ePKM_3YEQTQlaZk9kKrNoMgqsjcjA",
      authDomain: "votingmachine-c8e34.firebaseapp.com",
      projectId: "votingmachine-c8e34",
      storageBucket: "votingmachine-c8e34.appspot.com",
      appId: "1:175934636307:web:717f4a5ba28789f13f5ae6"
    };

    // ===== CSV URL (published Google Sheet) =====
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTnZExJ9injJGTsk1uFOUT45te0_gXPu0BGvAhgpWwNRIKxwgV3bXW-gygrr4omsBY9luXXxpPe1lE6/pub?output=csv';

    // Google Form redundancy (optional)
    const GOOGLE_FORM_URL = 'https://docs.google.com/forms/u/0/d/e/1FAIpQLSf9S0ksmz3OSCfcLHgaux1vGXfrDPR1Nl3Aa-Fe7soKM0Uvgg/formResponse';
    const FORM_ENTRY_IDS = {
      'Degree Program': 'entry.1688313048',
      'Student Number': 'entry.1533979100',
      'Voter ID': 'entry.1849133101',
      'Chairperson': 'entry.759707648',
      'Vice Chairperson': 'entry.192266479',
      'College Representative to the UFC': 'entry.809194796',
      'UFC Nominee': 'entry.1055485089',
      'Councilor': 'entry.692317949'
    };

    // ===== DOM references =====
    const googleLoginBtn = document.getElementById('google-login-btn');
    const header = document.getElementById('header');
    const votingWrapper = document.getElementById('voting-wrapper');
    const userNameEl = document.getElementById('user-name');
    const userEmailEl = document.getElementById('user-email');
    const userPhotoEl = document.getElementById('user-photo');
    const userIdDisplay = document.getElementById('user-id-display');

    const studentNumberInput = document.getElementById('student-number');
    const studentNumberError = document.getElementById('student-number-error');
    const degreeProgramInput = document.getElementById('degree-program');
    const proceedToBallotBtn = document.getElementById('proceed-to-ballot');
    const voterInfoSection = document.getElementById('voter-info-section');

    const votingForm = document.getElementById('voting-form');
    const ballotContainer = document.getElementById('ballot-container');

    const nomineePopup = document.getElementById('nominee-popup');
    const nomineePhotoEl = document.getElementById('nominee-photo');
    const nomineeNameEl = document.getElementById('nominee-name');
    const nomineePositionEl = document.getElementById('nominee-position');
    const nomineeCourseEl = document.getElementById('nominee-course');

    const photoViewer = document.getElementById('photo-viewer');
    const photoViewerImg = document.getElementById('photo-viewer-img');
    const closePhotoViewer = document.getElementById('close-photo-viewer');

    const verifierPopup = document.getElementById('verifier-popup');
    const voteSummaryEl = document.getElementById('vote-summary-table-container');
    const confirmVoteBtn = document.getElementById('confirm-vote-btn');
    const changeVoteBtn = document.getElementById('change-vote-btn');

    // turnout DOM
    const totalTurnoutText = document.getElementById('total-turnout-text');
    const totalTurnoutBar = document.getElementById('total-turnout-bar');
    const agriPercentEl = document.getElementById('agri-percent');
    const agriBar = document.getElementById('agri-bar');
    const biotechPercentEl = document.getElementById('biotech-percent');
    const biotechBar = document.getElementById('biotech-bar');
    const foodPercentEl = document.getElementById('food-percent');
    const foodBar = document.getElementById('food-bar');

    // ===== state =====
    let auth, db, currentUserId = null;
    let candidatesData = {};
    let allCandidateInfo = {};
    let voteDataToSubmit = {};
    let hasUserVoted = false;
    const REQUIRED_DOMAIN = '@up.edu.ph';
    const APP_ID = 'default-app-id';
    const VOTES_COLLECTION = `artifacts/${APP_ID}/public/data/votes`;
    const VOTER_INFO_COLLECTION = `artifacts/${APP_ID}/public/data/voters`;
    const AUTH_LOGS_COLLECTION = `artifacts/${APP_ID}/public/data/auth_logs`;

    // voting period
    let votingStart = null;
    let votingDeadline = null;

    // position order
    const positionOrder = ['Chairperson','Vice Chairperson','UFC Nominee','College Representative to the UFC','Councilor'];

    // ===== utilities =====
    const cellToIndex = (cell) => {
      const match = cell.match(/^([A-Z]+)(\d+)$/i);
      if (!match) return null;
      const colLetters = match[1].toUpperCase();
      const rowNumber = parseInt(match[2],10);
      let colIndex = 0;
      for (let i=0;i<colLetters.length;i++){
        colIndex = colIndex*26 + (colLetters.charCodeAt(i) - 65 + 1);
      }
      return { rowIndex: rowNumber - 1, colIndex: colIndex - 1 };
    };
    const readCellFromRows = (rows,cell) => {
      const idx = cellToIndex(cell);
      if (!idx) return '';
      if (rows[idx.rowIndex] && typeof rows[idx.rowIndex][idx.colIndex] !== 'undefined') return (rows[idx.rowIndex][idx.colIndex]||'').toString().trim();
      return '';
    };
    const tryParseDate = (s) => {
      if (!s) return null;
      const iso = new Date(s);
      if (!isNaN(iso)) return iso;
      const normalized = s.replace(/\//g,'-');
      const t = new Date(normalized);
      if (!isNaN(t)) return t;
      const p = Date.parse(s);
      if (!isNaN(p)) return new Date(p);
      return null;
    };

    // small transient message
    const showTransient = (txt, type='info') => {
      const el = document.createElement('div');
      el.textContent = txt;
      el.style.position = 'fixed';
      el.style.left = '50%';
      el.style.top = '16px';
      el.style.transform = 'translateX(-50%)';
      el.style.zIndex = 99999;
      el.style.padding = '8px 12px';
      el.style.borderRadius = '8px';
      el.style.fontWeight = '700';
      if (type==='error') { el.style.background = '#fee2e2'; el.style.color = '#7f1d1d'; }
      else if (type==='success') { el.style.background = '#ecfdf5'; el.style.color = '#065f46'; }
      else { el.style.background = '#f1f5f9'; el.style.color = '#0f172a'; }
      document.body.appendChild(el);
      setTimeout(()=>el.remove(), 3500);
    };

    // ===== turnout + voting period =====
    const fetchTurnoutAndPeriod = async () => {
      try {
        const resp = await fetch(CSV_URL);
        if (!resp.ok) throw new Error('CSV fetch failed ' + resp.status);
        const txt = await resp.text();
        const parsed = Papa.parse(txt, { skipEmptyLines:false });
        const rows = parsed.data;

        // parse voting period from G8 (start) and H8 (end)
        const startRaw = readCellFromRows(rows,'G8');
        const endRaw = readCellFromRows(rows,'H8');
        if (startRaw) votingStart = tryParseDate(startRaw);
        if (endRaw) votingDeadline = tryParseDate(endRaw);

        // turnout data: expected in G3-G6; actual in H3-H6 (as earlier)
        const parseNum = (v) => { if (!v) return NaN; const n = Number(String(v).replace(/[^0-9.-]/g,'')); return isNaN(n) ? NaN : n; };
        const expected = {
          total: parseNum(readCellFromRows(rows,'G6')),
          agri: parseNum(readCellFromRows(rows,'G3')),
          biotech: parseNum(readCellFromRows(rows,'G4')),
          food: parseNum(readCellFromRows(rows,'G5'))
        };
        const actual = {
          total: parseNum(readCellFromRows(rows,'H6')),
          agri: parseNum(readCellFromRows(rows,'H3')),
          biotech: parseNum(readCellFromRows(rows,'H4')),
          food: parseNum(readCellFromRows(rows,'H5'))
        };

        const safePct = (a,b) => (!isFinite(a) || !isFinite(b) || b<=0) ? 0 : Math.round((a/b)*100);
        const totalPct = safePct(actual.total, expected.total || actual.total || 1);
        totalTurnoutText.textContent = `${totalPct}%`;
        totalTurnoutBar.style.width = `${Math.min(100,totalPct)}%`;

        const agriPct = safePct(actual.agri, expected.agri || actual.agri || 1);
        agriPercentEl.textContent = `${agriPct}%`;
        agriBar.style.width = `${Math.min(100,agriPct)}%`;

        const bioPct = safePct(actual.biotech, expected.biotech || actual.biotech || 1);
        biotechPercentEl.textContent = `${bioPct}%`;
        biotechBar.style.width = `${Math.min(100,bioPct)}%`;

        const foodPct = safePct(actual.food, expected.food || actual.food || 1);
        foodPercentEl.textContent = `${foodPct}%`;
        foodBar.style.width = `${Math.min(100,foodPct)}%`;

        // check concluded: show concluded modal only when now > H8
        if (votingDeadline && (new Date() > votingDeadline)) {
          showVotingConcludedModal();
        } else {
          // if previously concluded modal exists and deadline passed removed (unlikely): do nothing
          // ensure UI enabled if not concluded
          document.documentElement.classList.remove('voting-ended-disable');
          document.querySelectorAll('button, input, select, textarea, [role="button"]').forEach(el => { try { el.disabled = false; } catch(e){} });
        }

      } catch (err) {
        console.error('fetchTurnoutAndPeriod err', err);
      }
    };
    fetchTurnoutAndPeriod();
    setInterval(fetchTurnoutAndPeriod, 60000); // every minute

    // ===== candidates load (no platform in modal; course stored for modal only) =====
    const loadCandidatesFromCSV = async () => {
      try {
        const resp = await fetch(CSV_URL);
        if (!resp.ok) throw new Error('CSV fetch failed ' + resp.status);
        const txt = await resp.text();
        const parsed = Papa.parse(txt, { skipEmptyLines:true });
        const rows = parsed.data;

        // update voting period too
        const startRaw = readCellFromRows(rows,'G8');
        const endRaw = readCellFromRows(rows,'H8');
        if (startRaw) votingStart = tryParseDate(startRaw);
        if (endRaw) votingDeadline = tryParseDate(endRaw);

        const grouped = {};
        const allInfo = {};
        for (let i=1;i<rows.length;i++){
          const row = rows[i];
          const name = (row[0]||'').trim();
          const position = (row[1]||'').trim();
          const photo = (row[2]||'').trim();
          const course = (row[3]||'').trim();
          if (!name || !position) continue;
          const info = { name, position, photo, course };
          allInfo[name] = info;
          if (!grouped[position]) grouped[position] = [];
          grouped[position].push(info);
        }
        candidatesData = grouped;
        allCandidateInfo = allInfo;
        renderBallot(grouped);
        preloadCandidateImages();
      } catch (err) {
        console.error('loadCandidatesFromCSV err', err);
      }
    };

    // render ballot (no per-position microtexts)
    const renderBallot = (candidates) => {
      let html = '';
      for (const pos of positionOrder) {
        const cands = candidates[pos] || [];
        html += `<div class="mb-6 p-4 bg-gray-50 rounded-xl border border-gray-200"><h3 class="text-xl font-extrabold text-custom-sub mb-2">${pos}</h3><div class="space-y-3">`;
        cands.forEach(info => {
          // each vote item: name on left, vote controls on right
          html += `
            <div class="vote-item" data-position="${pos}" data-name="${escapeHtml(info.name)}">
              <div class="candidate-name-container">
                <span class="candidate-name-link" data-candidate-name="${escapeHtml(info.name)}">${escapeHtml(info.name)}</span>
              </div>

              <div class="vote-controls">
                <div class="control-pill vote-column" data-action="vote" data-name="${escapeHtml(info.name)}" data-position="${escapeHtml(pos)}" role="button" tabindex="0" aria-pressed="false">
                  <span class="label">Vote</span><span class="dot" aria-hidden="true"></span>
                </div>
                <div class="controls-sep hidden sm:block" aria-hidden="true"></div>
                <div class="control-pill abstain-column" data-action="abstain" data-name="${escapeHtml(info.name)}" data-position="${escapeHtml(pos)}" role="button" tabindex="0" aria-pressed="false">
                  <span class="label">Abstain</span><span class="dot" aria-hidden="true"></span>
                </div>
              </div>
            </div>
          `;
        });
        html += `</div></div>`;
      }
      ballotContainer.innerHTML = html;
      attachBallotListeners();
    };

    // helper escape for insertion into HTML
    function escapeHtml(s){ return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }

    // preload images
    const preloadCandidateImages = () => {
      try {
        Object.values(allCandidateInfo).forEach(c => {
          if (c.photo) {
            const img = new Image();
            img.src = c.photo;
          }
        });
      } catch (e) { console.warn('preload err', e); }
    };

    // attach ballot listeners, ensure clickability fixed for all positions
    const attachBallotListeners = () => {
      // To ensure clickability, use event delegation at ballotContainer level for robust behavior
      ballotContainer.addEventListener('click', (ev) => {
        const el = ev.target.closest('.control-pill');
        if (!el) {
          const nameEl = ev.target.closest('.candidate-name-link');
          if (nameEl) {
            const nm = nameEl.dataset.candidateName;
            const info = allCandidateInfo[nm];
            if (info) openNomineeModal(info);
          }
          return;
        }
        // If voting concluded, ignore
        if (isVotingConcluded()) return;

        const action = el.dataset.action;
        const pos = el.dataset.position;
        const name = el.dataset.name;
        const isCouncil = pos === 'Councilor';
        if (!isCouncil) {
          // single choice: clear both control-pill siblings in same position and set only this one
          const pills = ballotContainer.querySelectorAll(`.control-pill[data-position="${cssEscape(pos)}"]`);
          pills.forEach(p => {
            p.classList.remove('selected');
            p.setAttribute('aria-pressed', 'false');
          });
          el.classList.add('selected');
          el.setAttribute('aria-pressed','true');
        } else {
          // toggle for councilor (but need to ensure each councilor gets exactly one selection when validating)
          const nowSelected = el.classList.toggle('selected');
          el.setAttribute('aria-pressed', nowSelected ? 'true' : 'false');
        }
      });

      // keyboard accessibility for control-pill
      ballotContainer.querySelectorAll('.control-pill').forEach(p => {
        p.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); p.click(); }
        });
      });

      // candidate name clicks
      ballotContainer.querySelectorAll('.candidate-name-link').forEach(el => {
        el.addEventListener('click', () => {
          const nm = el.dataset.candidateName;
          const info = allCandidateInfo[nm];
          if (info) openNomineeModal(info);
        });
      });
    };

    // CSS escape helper for attribute selectors
    function cssEscape(s) {
      if (!s) return '';
      return s.replace(/([^\w-])/g, '\\$1');
    }

    // nomination modal functions
    const openNomineeModal = (info) => {
      nomineePhotoEl.src = info.photo || 'https://placehold.co/128x128/f1f1f1/1F2933?text=ID';
      nomineeNameEl.textContent = info.name;
      nomineePositionEl.textContent = info.position || '';
      nomineeCourseEl.textContent = info.course || '';
      nomineePopup.classList.remove('hidden');
    };
    nomineePopup.addEventListener('click', (e) => {
      if (e.target === nomineePopup) nomineePopup.classList.add('hidden');
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') nomineePopup.classList.add('hidden');
    });

    // photo viewer open/close
    nomineePhotoEl.addEventListener('click', () => {
      photoViewerImg.src = nomineePhotoEl.src;
      photoViewer.classList.remove('hidden');
    });
    closePhotoViewer.addEventListener('click', () => photoViewer.classList.add('hidden'));
    photoViewer.addEventListener('click', (e) => { if (e.target === photoViewer) photoViewer.classList.add('hidden'); });

    // form submission -> verifier
    votingForm.addEventListener('submit', (ev) => {
      ev.preventDefault();
      if (isVotingConcluded()) { showVotingConcludedModal(); return; }
      // gather selections
      const results = {};
      let invalid = false;
      for (const pos of positionOrder) {
        const isCouncil = pos === 'Councilor';
        const rows = ballotContainer.querySelectorAll(`.vote-item[data-position="${cssEscape(pos)}"]`);
        if (isCouncil) {
          results[pos] = [];
          rows.forEach(r => {
            const name = r.dataset.name;
            const votePill = r.querySelector('.control-pill.vote-column');
            const abstainPill = r.querySelector('.control-pill.abstain-column');
            const voted = votePill && votePill.classList.contains('selected');
            const abstained = abstainPill && abstainPill.classList.contains('selected');
            if (!voted && !abstained) invalid = true;
            results[pos].push({ name, status: voted ? 'VOTED' : (abstained ? 'ABSTAINED' : 'NONE') });
          });
        } else {
          const selectedPill = ballotContainer.querySelector(`.control-pill[data-position="${cssEscape(pos)}"].selected`);
          if (!selectedPill) invalid = true;
          else {
            results[pos] = [{ name: selectedPill.dataset.name, status: selectedPill.dataset.action === 'vote' ? 'VOTED' : 'ABSTAINED' }];
          }
        }
      }

      if (invalid) { showTransient('Please complete all required selections.', 'error'); return; }

      // prepare summary HTML
      let html = '<div class="space-y-2">';
      for (const pos of positionOrder) {
        html += `<div class="font-bold text-sm text-custom-sub pt-2">${pos}</div>`;
        const entries = results[pos] || [];
        entries.forEach(e => {
          const cls = e.status === 'VOTED' ? 'text-custom-main font-bold' : (e.status === 'ABSTAINED' ? 'text-gray-600 font-bold' : 'text-gray-400');
          html += `<div class="${cls} text-sm">${escapeHtml(e.name)} ‚Äî ${escapeHtml(e.status)}</div>`;
        });
      }
      html += '</div>';
      voteSummaryEl.innerHTML = html;
      voteDataToSubmit = results;
      verifierPopup.classList.remove('hidden');
    });

    changeVoteBtn.addEventListener('click', () => verifierPopup.classList.add('hidden'));

    // Confirm vote: Firestore transaction and redundancy form submission
    confirmVoteBtn.addEventListener('click', async () => {
      if (!currentUserId) { showTransient('Not authenticated.', 'error'); return; }
      // transaction: ensure single submission per user
      try {
        const voteDocRef = doc(db, VOTES_COLLECTION, currentUserId);
        await runTransaction(db, async (tx) => {
          const snap = await tx.get(voteDocRef);
          if (snap.exists()) throw new Error('ALREADY_VOTED');
          tx.set(voteDocRef, { voterId: currentUserId, timestamp: new Date(), selections: voteDataToSubmit });
        });
        // mark voter as voted
        try {
          const voterRef = doc(db, VOTER_INFO_COLLECTION, currentUserId);
          await setDoc(voterRef, { voted: 1, updatedAt: new Date() }, { merge: true });
        } catch (err) { console.warn('mark voter voted failed', err); }

        // optional: Google Form redundancy (no-cors)
        sendToGoogleForm(voteDataToSubmit, currentUserId).catch(e => console.warn('form redundancy failed', e));

        verifierPopup.classList.add('hidden');
        showTransient('Your ballot has been securely submitted. Thank you.', 'success');

        // sign out user and return to login
        try { await signOut(auth); } catch (e){ console.warn('signout after submit failed', e); }
        header.classList.add('hidden');
        votingWrapper.classList.add('hidden');
        document.querySelector('main').style.display = ''; // show main
      } catch (err) {
        console.error('confirm vote err', err);
        if (err.message && err.message.includes('ALREADY_VOTED')) {
          showTransient('You have already voted.', 'error');
          // disable form
          document.documentElement.classList.add('voting-ended-disable');
          setAllInteractiveDisabled(true);
        } else {
          showTransient('Failed to submit vote. Please try again.', 'error');
        }
      }
    });

    const sendToGoogleForm = async (voteStruct, uid) => {
      try {
        // fetch voter info for redundancy
        let studentNumber = '';
        let degreeProgram = '';
        try {
          const vRef = doc(db, VOTER_INFO_COLLECTION, uid);
          const vSnap = await getDoc(vRef);
          if (vSnap.exists()) {
            const d = vSnap.data();
            studentNumber = d.studentNumber || '';
            degreeProgram = d.course || '';
          }
        } catch(e){}

        const formData = new FormData();
        formData.append(FORM_ENTRY_IDS['Voter ID'], uid);
        formData.append(FORM_ENTRY_IDS['Student Number'], studentNumber);
        formData.append(FORM_ENTRY_IDS['Degree Program'], degreeProgram);

        for (const position in voteStruct) {
          const eId = FORM_ENTRY_IDS[position];
          if (!eId) continue;
          const recs = voteStruct[position];
          recs.forEach(r => {
            formData.append(eId, `${r.name} ‚Äî ${r.status}`);
          });
        }
        // no-cors mode is used to fire-and-forget
        await fetch(GOOGLE_FORM_URL, { method: 'POST', mode: 'no-cors', body: formData });
      } catch (err) {
        console.warn('sendToGoogleForm err', err);
      }
    };

    // set all interactive disabled (used when voting concluded or after submission)
    const setAllInteractiveDisabled = (disabled) => {
      document.querySelectorAll('button, input, select, textarea, [role="button"]').forEach(el => {
        try { el.disabled = !!disabled; } catch(e){}
      });
      if (disabled) document.documentElement.classList.add('voting-ended-disable');
      else document.documentElement.classList.remove('voting-ended-disable');
    };

    // ===== Voting concluded modal (only when now > H8) =====
    function isVotingConcluded() {
      if (!votingDeadline) return false;
      return new Date() > votingDeadline;
    }

    function showVotingConcludedModal() {
      // if already present, do nothing
      if (document.getElementById('voting-ended-modal')) return;
      // Insert modal BEFORE disabling UI, so modal stays interactive
      const html = `
        <div id="voting-ended-modal" class="fixed inset-0 z-[99999] flex items-center justify-center">
          <div class="absolute inset-0 modal-backdrop"></div>
          <div class="relative max-w-2xl w-full bg-white rounded-xl shadow-2xl border-t-8 border-custom-sub text-center p-8">
            <h2 class="text-2xl font-extrabold text-custom-sub mb-4">THE VOTING PERIOD HAS CONCLUDED.</h2>
            <p class="text-gray-700">Wait for the official vote results to be posted in the <strong>CAFS FC Facebook Page</strong>.</p>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', html);

      // Now disable all interactive elements but leave modal interactive (CSS overrides)
      setAllInteractiveDisabled(true);
    }

    // ===== CSV fetch + candidates initial load =====
    loadCandidatesFromCSV();

    // ===== Firebase init + auth flows =====
    let app, provider;
    try {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);
      provider = new GoogleAuthProvider();
    } catch (err) {
      console.warn('firebase init warning', err);
    }

    // Sign-in handler
    googleLoginBtn.addEventListener('click', async () => {
      // if voting concluded, show modal and block
      if (isVotingConcluded()) { showVotingConcludedModal(); return; }
      googleLoginBtn.disabled = true;
      const orig = googleLoginBtn.innerHTML;
      googleLoginBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="white" stroke-width="4" opacity="0.25"></circle></svg>Signing in...';
      try {
        const result = await signInWithPopup(auth, provider);
        const u = result.user;
        if (!u.email || !u.email.endsWith(REQUIRED_DOMAIN)) {
          showTransient('Please sign in using a valid UP Mail (@up.edu.ph).', 'error');
          await signOut(auth);
          return;
        }
      } catch (err) {
        console.error('signIn err', err);
        showTransient('Sign-in failed. Try again.', 'error');
      } finally {
        googleLoginBtn.disabled = false;
        googleLoginBtn.innerHTML = orig;
      }
    });

    // auth state changes
    onAuthStateChanged(getAuth(), async (user) => {
      if (user) {
        // user logged-in
        currentUserId = user.uid;
        userNameEl.textContent = user.displayName || '';
        userEmailEl.textContent = user.email || '';
        userPhotoEl.src = user.photoURL || 'https://placehold.co/32x32/f1f1f1/1F2933?text=U';
        userIdDisplay.textContent = currentUserId;
        // swap UI
        document.querySelector('main').style.display = 'none';
        header.classList.remove('hidden');
        votingWrapper.classList.remove('hidden');
        // prefill voter info if exists
        try {
          const voterRef = doc(db, VOTER_INFO_COLLECTION, currentUserId);
          const snap = await getDoc(voterRef);
          if (snap.exists()) {
            const d = snap.data();
            if (d.studentNumber) studentNumberInput.value = d.studentNumber;
            if (d.course) degreeProgramInput.value = d.course;
            if (d.studentNumber && d.course) {
              voterInfoSection.style.display = 'none';
              votingForm.classList.remove('opacity-50'); votingForm.classList.remove('pointer-events-none');
            }
          }
        } catch (e) { console.warn('prefill voter info err', e); }

        // check whether already voted
        try {
          const voteRef = doc(db, VOTES_COLLECTION, currentUserId);
          const vsnap = await getDoc(voteRef);
          if (vsnap.exists()) {
            showTransient('You have already submitted your ballot.', 'success');
            hasUserVoted = true;
            setAllInteractiveDisabled(true);
          } else {
            hasUserVoted = false;
          }
        } catch (err) { console.warn('check voted err', err); }
      } else {
        // logged out
        currentUserId = null;
        header.classList.add('hidden');
        votingWrapper.classList.add('hidden');
        document.querySelector('main').style.display = '';
        setAllInteractiveDisabled(false);
      }
    });

    // logout
    document.getElementById('logout-btn').addEventListener('click', async () => {
      try { await signOut(getAuth()); } catch(e){ console.warn('logout err', e); }
    });

    // proceed to ballot: save voter info to Firestore
    proceedToBallotBtn.addEventListener('click', async () => {
      if (!currentUserId) { showTransient('Please sign in first.', 'error'); return; }
      const sn = studentNumberInput.value.trim();
      const course = degreeProgramInput.value.trim();
      if (!/^20\d{2}-\d{5}$/.test(sn)) {
        studentNumberError.classList.remove('hidden');
        studentNumberInput.classList.add('border-red-500');
        return;
      } else {
        studentNumberError.classList.add('hidden');
        studentNumberInput.classList.remove('border-red-500');
      }
      if (!course) { showTransient('Please select your degree program.', 'error'); return; }

      try {
        await setDoc(doc(db, VOTER_INFO_COLLECTION, currentUserId), {
          voterId: currentUserId,
          studentNumber: sn,
          course,
          voted: 0,
          updatedAt: new Date()
        }, { merge: true });
        voterInfoSection.style.display = 'none';
        votingForm.classList.remove('opacity-50'); votingForm.classList.remove('pointer-events-none');
        showTransient('Voter information saved. You may now cast your vote.', 'success');
      } catch (err) {
        console.error('save voter info err', err);
        showTransient('Failed to save voter info. Try again.', 'error');
      }
    });

    // helper: show voting concluded modal if needed on load
    // already invoked in fetchTurnoutAndPeriod

    // utility: when page loads, fetch CSV for candidates and turnout
    (async () => {
      await loadCandidatesFromCSV();
      await fetchTurnoutAndPeriod();
    })();

    // small anti-copy deterrent (keeps previous behavior)
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('copy', e => e.preventDefault());

    // Accessibility: close verifier on ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        try { verifierPopup.classList.add('hidden'); } catch(e){}
      }
    });

    // DONE

  </script>
</body>
</html>
